<!doctype html><html lang=en-uk><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://basilesimon.fr/images/favicon.png><title>Mapping storms in R</title><meta name=title content="Mapping storms in R"><meta name=description content="How to map 10 years of storms in the Pacific, with R and ggplot"><meta name=keywords content="r,viz,"><meta property="og:title" content="Mapping storms in R"><meta property="og:description" content="How to map 10 years of storms in the Pacific, with R and ggplot"><meta property="og:type" content="article"><meta property="og:url" content="https://basilesimon.fr/blog/storms-map-in-r/"><meta property="og:image" content="https://basilesimon.fr/images/share.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2018-09-05T00:00:00+00:00"><meta property="article:modified_time" content="2018-09-05T00:00:00+00:00"><meta property="og:site_name" content="~basile"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://basilesimon.fr/images/share.png"><meta name=twitter:title content="Mapping storms in R"><meta name=twitter:description content="How to map 10 years of storms in the Pacific, with R and ggplot"><meta itemprop=name content="Mapping storms in R"><meta itemprop=description content="How to map 10 years of storms in the Pacific, with R and ggplot"><meta itemprop=datePublished content="2018-09-05T00:00:00+00:00"><meta itemprop=dateModified content="2018-09-05T00:00:00+00:00"><meta itemprop=wordCount content="749"><meta itemprop=image content="https://basilesimon.fr/images/share.png"><meta itemprop=keywords content="r,viz,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><base href=https://basilesimon.fr/><link rel=stylesheet href=main.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel=stylesheet></head><body><header><a href=/ class=title><h2>ðŸ‘‹ hi, Iâ€™m basile</h2></a><nav><a href=/>Home</a>
<a href=/blog>Blog</a>
<a href=/weeknotes>Weeknotes</a></nav></header><main><article class=single><h1>Mapping storms in R</h1><p><i><time datetime=2018-09-05 pubdate>05 Sep, 2018</time></i></p><content><p><img src=/assets/storms_final.png alt></p><p>Japan is currently counting the cost of the strongest typhoon to hit its coasts in 25 years. The death toll currently stands at nine, and hundreds were injured.</p><p>The north western Pacific basin sees many storms, and meteorology agencies release loads of data about climate events such as these. For this example, we are going to use the work of the National Oceanic and Atmospheric Administration, which releases datasets known as <a href=https://www.ncdc.noaa.gov/ibtracs/>International Best Track Archive for Climate Stewardship</a>.</p><p>Head to &ldquo;data access&rdquo; and make your way to the <a href=ftp://eclipse.ncdc.noaa.gov/pub/ibtracs/v03r10/all/csv/basin>CSV release</a> for each oceanic basin. We need the western Pacific one.</p><p><em>This blog was contributed to <a href=https://www.r-bloggers.com/>R Bloggers</a></em></p><hr><h1 id=preparing-data-and-basic-mapping>Preparing data and basic mapping</h1><p>Now let&rsquo;s load our packages. No need for <code>rgdal</code>, we&rsquo;ll do everything in <code>ggplot</code>.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=color:#900;font-weight:700>library</span>(ggplot2)
<span style=color:#900;font-weight:700>library</span>(dplyr)
</code></pre></div><p>We read our data source in and just clean things up a bit.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=color:#998;font-style:italic># data source</span>
basin <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>read.csv</span>(<span style=color:#d14>&#39;Basin.WP.ibtracs_all.v03r10.csv&#39;</span>,
                  skip <span style=color:#000;font-weight:700>=</span> <span style=color:#099>1</span>, stringsAsFactors <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>FALSE</span>)
basin <span style=color:#000;font-weight:700>&lt;-</span> basin[<span style=color:#099>-1</span>, ] <span style=color:#998;font-style:italic># first column is garbled, disegard</span>

<span style=color:#998;font-style:italic># cleaner columns</span>
basin<span style=color:#000;font-weight:700>$</span>Season <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>as.numeric</span>(basin<span style=color:#000;font-weight:700>$</span>Season)
basin<span style=color:#000;font-weight:700>$</span>Latitude <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>as.numeric</span>(<span style=color:#900;font-weight:700>gsub</span>(<span style=color:#d14>&#34;^ &#34;</span>, <span style=color:#d14>&#34;&#34;</span>, basin<span style=color:#000;font-weight:700>$</span>Latitude))
basin<span style=color:#000;font-weight:700>$</span>Longitude <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>as.numeric</span>(<span style=color:#900;font-weight:700>gsub</span>(<span style=color:#d14>&#34;^ &#34;</span>, <span style=color:#d14>&#34;&#34;</span>, basin<span style=color:#000;font-weight:700>$</span>Longitude))
basin<span style=color:#000;font-weight:700>$</span>Wind.WMO. <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>as.numeric</span>(<span style=color:#900;font-weight:700>gsub</span>(<span style=color:#d14>&#34;^ &#34;</span>, <span style=color:#d14>&#34;&#34;</span>, basin<span style=color:#000;font-weight:700>$</span>Wind.WMO.))
basin<span style=color:#000;font-weight:700>$</span>Name <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>as.factor</span>(basin<span style=color:#000;font-weight:700>$</span>Name)
</code></pre></div><p>For the purpose of this exercise, we want to visualise 2000 to 2017 data. Sadly our dataset does not contain data for 2018 yet&mldr; Please excuse my poor chaining of <code>filter()</code> methods &ndash; I am but a journalist after all.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=color:#998;font-style:italic># extract 2000 to 2017 data</span>
<span style=color:#998;font-style:italic># also remove some weird datapoints</span>
substorms <span style=color:#000;font-weight:700>&lt;-</span> basin <span style=color:#000;font-weight:700>%&gt;%</span>
  <span style=color:#900;font-weight:700>filter</span>(Season <span style=color:#000;font-weight:700>%in%</span> <span style=color:#099>2000</span><span style=color:#000;font-weight:700>:</span><span style=color:#099>2017</span>) <span style=color:#000;font-weight:700>%&gt;%</span>
  <span style=color:#900;font-weight:700>filter</span>(<span style=color:#000;font-weight:700>!</span>Name <span style=color:#000;font-weight:700>==</span> <span style=color:#d14>&#34;NOT NAMED&#34;</span>) <span style=color:#000;font-weight:700>%&gt;%</span>
  <span style=color:#900;font-weight:700>filter</span>(<span style=color:#000;font-weight:700>!</span>Latitude <span style=color:#000;font-weight:700>==</span> <span style=color:#099>-999</span>) <span style=color:#000;font-weight:700>%&gt;%</span>
  <span style=color:#900;font-weight:700>filter</span>(<span style=color:#000;font-weight:700>!</span>Longitude <span style=color:#000;font-weight:700>==</span> <span style=color:#099>-999</span>)

substorms<span style=color:#000;font-weight:700>$</span>ID <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>as.factor</span>(<span style=color:#900;font-weight:700>paste</span>(substorms<span style=color:#000;font-weight:700>$</span>Name, substorms<span style=color:#000;font-weight:700>$</span>Season, 
                                sep <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#d14>&#34;.&#34;</span>))
</code></pre></div><p>We&rsquo;re going to rely on <code>map_data("world")</code> for our base map. In <code>ggplot</code> world that&rsquo;s how we build that up:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=color:#998;font-style:italic># world map</span>
<span style=color:#900;font-weight:700>ggplot</span>() <span style=color:#000;font-weight:700>+</span>
  <span style=color:#900;font-weight:700>geom_polygon</span>(data <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>map_data</span>(<span style=color:#d14>&#34;world&#34;</span>),
  <span style=color:#900;font-weight:700>aes</span>(x <span style=color:#000;font-weight:700>=</span> long, y <span style=color:#000;font-weight:700>=</span> lat, group <span style=color:#000;font-weight:700>=</span> group))
</code></pre></div><p><img src=assets/worldmap.png alt></p><p>Our storms will be a set of <code>geom_path()</code> which lat/long coordinates we&rsquo;ve passed in at the top.</p><p>The object of our study here is a series of tracks followed by each storm. Representing tracks as lines feels natural.
As our data comes as a list of points, we need to group together all the points that represent one storm. Were we studying say, the winds, we would run something like this, grouping our points by storm unique ID.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r>substorms <span style=color:#000;font-weight:700>%&gt;%</span>
  <span style=color:#900;font-weight:700>group_by</span>(ID) <span style=color:#000;font-weight:700>%&gt;%</span>
  <span style=color:#900;font-weight:700>summarise</span>(average_winds <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>mean</span>(Wind.WMO.)) <span style=color:#000;font-weight:700>%&gt;%</span> 
  <span style=color:#900;font-weight:700>arrange</span>(<span style=color:#900;font-weight:700>desc</span>(average_winds))
  
A tibble<span style=color:#000;font-weight:700>:</span> <span style=color:#099>401</span> x <span style=color:#099>2</span>
   ID               average_winds
   <span style=color:#000;font-weight:700>&lt;</span>fct<span style=color:#000;font-weight:700>&gt;</span>                    <span style=color:#000;font-weight:700>&lt;</span>dbl<span style=color:#000;font-weight:700>&gt;</span>
 <span style=color:#099>1</span> JELAWAT <span style=color:#099>2012</span> .            <span style=color:#099>71.4</span>
 <span style=color:#099>2</span> HAIYAN <span style=color:#099>2013</span> .             <span style=color:#099>70.5</span>
 <span style=color:#099>3</span> CHOI<span style=color:#000;font-weight:700>-</span>WAN <span style=color:#099>2009</span> .           <span style=color:#099>69.2</span>
 <span style=color:#099>4</span> FENGSHEN <span style=color:#099>2002</span> .           <span style=color:#099>68.8</span>
 <span style=color:#099>5</span> MEGI <span style=color:#099>2010</span> .               <span style=color:#099>68.7</span>
</code></pre></div><p>We can do the same inside <code>ggplot</code> by passing <code>aes(group = ID)</code>. Here is our result:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=color:#900;font-weight:700>ggplot</span>(substorms, <span style=color:#900;font-weight:700>aes</span>(x <span style=color:#000;font-weight:700>=</span> Longitude, y <span style=color:#000;font-weight:700>=</span> Latitude, group <span style=color:#000;font-weight:700>=</span> ID)) <span style=color:#000;font-weight:700>+</span> 
  <span style=color:#900;font-weight:700>geom_polygon</span>(data <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>map_data</span>(<span style=color:#d14>&#34;world&#34;</span>), <span style=color:#900;font-weight:700>aes</span>(x <span style=color:#000;font-weight:700>=</span> long, y <span style=color:#000;font-weight:700>=</span> lat, group <span style=color:#000;font-weight:700>=</span> group)) <span style=color:#000;font-weight:700>+</span>
  <span style=color:#900;font-weight:700>geom_path</span>(data <span style=color:#000;font-weight:700>=</span> substorms, <span style=color:#900;font-weight:700>aes</span>(group <span style=color:#000;font-weight:700>=</span> ID))
</code></pre></div><p><img src=assets/worldmap1.png alt></p><p>Now let&rsquo;s add some styles. We also need to limit our map coordinates to Asia and the Pacific, and <em>voilÃ </em>.</p><p>Edit December 2018: In order to prevent the odd clipping and horizontal lines from <code>coord_map()</code>, we need to clip the world map polygons ahead of rendering:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r>wm <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>map_data</span>(<span style=color:#d14>&#34;world&#34;</span>)

<span style=color:#900;font-weight:700>library</span>(<span style=color:#d14>&#34;PBSmapping&#34;</span>)
data.table<span style=color:#000;font-weight:700>::</span><span style=color:#900;font-weight:700>setnames</span>(wm, <span style=color:#900;font-weight:700>c</span>(<span style=color:#d14>&#34;X&#34;</span>,<span style=color:#d14>&#34;Y&#34;</span>,<span style=color:#d14>&#34;PID&#34;</span>,<span style=color:#d14>&#34;POS&#34;</span>,<span style=color:#d14>&#34;region&#34;</span>,<span style=color:#d14>&#34;subregion&#34;</span>))
worldmap <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>clipPolys</span>(wm, xlim<span style=color:#000;font-weight:700>=</span><span style=color:#900;font-weight:700>c</span>(<span style=color:#099>60</span>,<span style=color:#099>180</span>),ylim<span style=color:#000;font-weight:700>=</span><span style=color:#900;font-weight:700>c</span>(<span style=color:#099>-20</span>, <span style=color:#099>60</span>), keepExtra<span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>TRUE</span>)
</code></pre></div><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r>theme_opts<span style=color:#000;font-weight:700>&lt;-</span><span style=color:#900;font-weight:700>list</span>(<span style=color:#900;font-weight:700>theme</span>(panel.grid.minor <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       panel.grid.major <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       panel.background <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       plot.background <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       axis.line <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       axis.text.x <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       axis.text.y <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       axis.ticks <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       axis.title.x <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       axis.title.y <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>(),
                       plot.title <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>element_blank</span>()))
                       
<span style=color:#900;font-weight:700>ggplot</span>(substorms, <span style=color:#900;font-weight:700>aes</span>(x <span style=color:#000;font-weight:700>=</span> Longitude, y <span style=color:#000;font-weight:700>=</span> Latitude, group <span style=color:#000;font-weight:700>=</span> ID)) <span style=color:#000;font-weight:700>+</span> 
  <span style=color:#900;font-weight:700>geom_polygon</span>(data <span style=color:#000;font-weight:700>=</span> worldmap, <span style=color:#900;font-weight:700>aes</span>(x <span style=color:#000;font-weight:700>=</span> X, y <span style=color:#000;font-weight:700>=</span> Y, group <span style=color:#000;font-weight:700>=</span> PID), 
               fill <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;whitesmoke&#34;</span>, colour <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;gray10&#34;</span>, size <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0.2</span>) <span style=color:#000;font-weight:700>+</span>
  <span style=color:#900;font-weight:700>geom_path</span>(data <span style=color:#000;font-weight:700>=</span> substorms, <span style=color:#900;font-weight:700>aes</span>(group <span style=color:#000;font-weight:700>=</span> ID), 
            alpha <span style=color:#000;font-weight:700>=</span> substorms<span style=color:#000;font-weight:700>$</span>Wind.WMO.<span style=color:#000;font-weight:700>/</span><span style=color:#099>500</span>, size <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0.8</span>,
            color <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;red&#34;</span>) <span style=color:#000;font-weight:700>+</span> 
  <span style=color:#900;font-weight:700>coord_map</span>(xlim <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>c</span>(<span style=color:#099>60</span>,<span style=color:#099>180</span>), ylim <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>c</span>(<span style=color:#099>-20</span>, <span style=color:#099>60</span>)) <span style=color:#000;font-weight:700>+</span>
  <span style=color:#900;font-weight:700>labs</span>(x <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;&#34;</span>, y <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;&#34;</span>, colour <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;Wind \n(knots)&#34;</span>) <span style=color:#000;font-weight:700>+</span> theme_opts
</code></pre></div><p><img src=assets/storms_all.png alt></p><hr><h1 id=storms-by-year-and-month>Storms by year and month</h1><p>Now who doesn&rsquo;t like a good facetting? That&rsquo;s how I fell in love with <code>ggplot</code> in the first place. We can easily extract dates from our data in order to prepare for different facetting opportunities.</p><p>Facetting by year allows us to visually (and relatively unreliably) compare years against each other. Doing the same operation by month will show when do typhoons mostly hit in the Pacific. (Edit December 2018: we now use <code>lubridate</code> functions to do so.)</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=color:#998;font-style:italic># extract month and year for facetting later</span>
<span style=color:#900;font-weight:700>library</span>(lubridate)
substorms <span style=color:#000;font-weight:700>&lt;-</span> substorms <span style=color:#000;font-weight:700>%&gt;%</span>
  <span style=color:#900;font-weight:700>mutate</span>(Month <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>month</span>(<span style=color:#900;font-weight:700>as.Date</span>(ISO_time))) <span style=color:#000;font-weight:700>%&gt;%</span>
  <span style=color:#900;font-weight:700>mutate</span>(Year <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>year</span>(<span style=color:#900;font-weight:700>as.Date</span>(ISO_time)))
</code></pre></div><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r>  <span style=color:#000;font-weight:700>+</span> <span style=color:#900;font-weight:700>facet_wrap</span>(<span style=color:#000;font-weight:700>~</span>Year)
</code></pre></div><p><img src=assets/storms_years.png alt></p><p>And finally, by month (with the types done up in Illustrator):</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r>  <span style=color:#000;font-weight:700>+</span> <span style=color:#900;font-weight:700>facet_wrap</span>(<span style=color:#000;font-weight:700>~</span>Month)
</code></pre></div><p><img src=assets/storms_final.png alt></p></content><p><a href=https://basilesimon.fr/tags/r/>#r</a>
<a href=https://basilesimon.fr/tags/viz/>#viz</a></p></article></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a></footer></body></html>