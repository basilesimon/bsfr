name: github pages

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true # Fetch Hugo themes (true OR recursive)
          fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "0.136.0"

      - name: Build
        run: hugo --minify

      # C2PA signing for blog posts
      - name: Setup Rust
        if: github.ref == 'refs/heads/main'
        uses: dtolnay/rust-action@stable

      - name: Cache html-c2pa build
        if: github.ref == 'refs/heads/main'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/html-c2pa
            tools/html-c2pa/target
          key: html-c2pa-${{ hashFiles('tools/html-c2pa/Cargo.toml', 'tools/html-c2pa/src/**') }}

      - name: Build html-c2pa
        if: github.ref == 'refs/heads/main'
        run: |
          if [ ! -f ~/.cargo/bin/html-c2pa ]; then
            cargo install --path tools/html-c2pa
          fi

      - name: Sign blog posts with C2PA
        if: github.ref == 'refs/heads/main'
        env:
          C2PA_SIGN_CERT: ${{ secrets.C2PA_SIGN_CERT }}
          C2PA_PRIVATE_KEY: ${{ secrets.C2PA_PRIVATE_KEY }}
        run: |
          # Write credentials to temp files
          echo "$C2PA_SIGN_CERT" > /tmp/cert.pem
          echo "$C2PA_PRIVATE_KEY" > /tmp/key.pem

          # Sign each blog post
          for post in public/blog/*/index.html; do
            ~/.cargo/bin/html-c2pa "$post" \
              --sign-cert /tmp/cert.pem \
              --private-key /tmp/key.pem
          done

          # Sign weeknotes too
          for post in public/weeknotes/*/index.html; do
            ~/.cargo/bin/html-c2pa "$post" \
              --sign-cert /tmp/cert.pem \
              --private-key /tmp/key.pem
          done

          # Clean up credentials
          rm -f /tmp/cert.pem /tmp/key.pem

          echo "Signed $(find public -name '*.c2pa' | wc -l) files"

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          cname: basilesimon.fr
